parameters:
- name: rootPath
  type: string
  default: '$(Build.SourcesDirectory)'

steps:
- task: SFP.build-tasks.custom-build-task-1.EsrpCodeSigning@5
  displayName: ESRP CodeSigning
  inputs:
    ConnectedServiceName: '$(Control.EsrpServiceConnectionName)'
    AppRegistrationClientId: '$(Control.AppRegistrationClientId)'
    AppRegistrationTenantId: '$(Control.AppRegistrationTenantId)'
    AuthAKVName: '$(Control.AuthAKVName)'
    AuthCertName: '$(Control.AuthCertName)'
    AuthSignCertName: '$(Control.AuthSignCertName)'
    FolderPath: ${{ parameters.rootPath }}
    Pattern: '*.vsix'
    signConfigType: inlineSignParams
    inlineOperation: |-
      [
        {
          "KeyCode": "CP-500813",
          "OperationCode": "AdoExtensionSign",
          "ToolName": "sign",
          "ToolVersion": "1.0",
          "Parameters": { }
        },
        {
          "KeyCode": "CP-500813",
          "OperationCode": "AdoExtensionVerify",
          "ToolName": "sign",
          "ToolVersion": "1.0",
          "Parameters": {}
        }
      ]
    SessionTimeout: 30

- task: CopyFiles@2
  displayName: 'Copy signed VSIX files'
  inputs:
    contents: '**/*.vsix'
    sourceFolder: ${{parameters.rootPath}}
    flattenFolders: true
    targetFolder: $(System.ArtifactsDirectory)/signed-vsix
